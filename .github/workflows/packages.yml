name: release
on:
  push:
    tags:
      - '*'

jobs:
  packages:
    name: packagecloud
    runs-on: ubuntu-latest
    env:
      BUILDER_NAME: "GitHub Actions"
      BUILDER_EMAIL: noreply@actions.github.com

    steps:

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
      id: go

    - name: Check out code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: install dependencies
      run: |
        sudo apt update
        sudo apt install -y pandoc
        sudo gem install fpm package_cloud

    - name: build and run unit tests
      run: make clean all test

    - name: deploy packages
      run: make deploy-packages
      env:
        PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}

  release:
    name: github
    runs-on: ubuntu-latest
    permissions:
      contents: write
      attestations: write
      id-token: write

    steps:

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: 'stable'
      id: go

    - name: Check out code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Install pandoc
      run: |
        sudo apt update
        sudo apt install -y pandoc

    - name: Generate manpage
      run: make checkmake.1

    - name: Prepare release notes
      run: |
        # Extract version from tag (tags are 0.3.0 format, not v0.3.0)
        # Release notes files should be named 0.3.0.md (matching tag format)
        VERSION=${GITHUB_REF#refs/tags/}
        if [ -f "docs/releases/${VERSION}.md" ]; then
          cp "docs/releases/${VERSION}.md" RELEASE_NOTES.md
          echo "Release notes found for ${VERSION}"
        else
          echo "# Release ${VERSION}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> RELEASE_NOTES.md
          echo "Release notes file not found, using placeholder"
        fi

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v6
      with:
        version: latest
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GOVERSION: ${{ steps.goversion.outputs.version }}

  docker:
    name: docker
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Determine if pre-release
      id: prerelease
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        # Check if tag contains pre-release indicators
        if [[ "$TAG" =~ -(next|alpha|beta|rc|dev|snapshot) ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG is a pre-release, skipping 'latest' tag"
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG is a stable release, will tag as 'latest'"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: mrtazz
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Prepare Docker tags
      id: docker_tags
      run: |
        TAG=${{ steps.prerelease.outputs.tag }}
        SHA=${{ github.sha }}
        TAGS="mrtazz/checkmake:${TAG},mrtazz/checkmake:${SHA}"
        if [ "${{ steps.prerelease.outputs.is_prerelease }}" = "false" ]; then
          TAGS="${TAGS},mrtazz/checkmake:latest"
        fi
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "Docker tags: ${TAGS}"

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        build-args: |
          BUILDER_NAME=GitHub Actions
          BUILDER_EMAIL=noreply@actions.github.com
        push: true
        tags: ${{ steps.docker_tags.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
