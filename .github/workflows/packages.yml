name: release
on:
  push:
    tags:
      - '*'

jobs:
  packages:
    name: packagecloud
    runs-on: ubuntu-latest
    env:
      BUILDER_NAME: "GitHub Actions"
      BUILDER_EMAIL: noreply@actions.github.com

    steps:

    - name: Set up Go 1.13
      uses: actions/setup-go@v6
      with:
        go-version: 1.13
      id: go

    - name: Check out code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: install dependencies
      run: |
        sudo wget https://github.com/jgm/pandoc/releases/download/2.7.3/pandoc-2.7.3-1-amd64.deb
        sudo dpkg -i pandoc-2.7.3-1-amd64.deb
        rm -f pandoc-2.7.3-1-amd64.deb
        sudo gem install fpm package_cloud

    - name: build and run unit tests
      run: make clean all test

    - name: deploy packages
      run: make deploy-packages
      env:
        PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}

  release:
    name: github
    runs-on: ubuntu-latest
    env:
      BUILDER_NAME: "GitHub Actions"
      BUILDER_EMAIL: noreply@actions.github.com

    steps:

    - name: Set up Go 1.17
      uses: actions/setup-go@v6
      with:
        go-version: 1.17
      id: go

    - name: Check out code
      uses: actions/checkout@v5
      with:
        fetch-depth: 1

    - name: install dependencies
      run: |
        sudo wget https://github.com/jgm/pandoc/releases/download/2.7.3/pandoc-2.7.3-1-amd64.deb
        sudo dpkg -i pandoc-2.7.3-1-amd64.deb

    - name: build for platforms
      run: |
        BUILD_GOARCH=amd64 BUILD_GOOS=freebsd make build-standalone
        BUILD_GOARCH=amd64 BUILD_GOOS=linux   make build-standalone
        BUILD_GOARCH=amd64 BUILD_GOOS=darwin  make build-standalone
        BUILD_GOARCH=arm64 BUILD_GOOS=darwin  make build-standalone
        BUILD_GOARCH=amd64 BUILD_GOOS=windows make build-standalone
        BUILD_GOARCH=arm64 BUILD_GOOS=windows make build-standalone

    - name: create release
      run: make github-release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: docker
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Determine if pre-release
      id: prerelease
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        # Check if tag contains pre-release indicators
        if [[ "$TAG" =~ -(next|alpha|beta|rc|dev|snapshot) ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG is a pre-release, skipping 'latest' tag"
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG is a stable release, will tag as 'latest'"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: mrtazz
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Prepare Docker tags
      id: docker_tags
      run: |
        TAG=${{ steps.prerelease.outputs.tag }}
        SHA=${{ github.sha }}
        TAGS="mrtazz/checkmake:${TAG},mrtazz/checkmake:${SHA}"
        if [ "${{ steps.prerelease.outputs.is_prerelease }}" = "false" ]; then
          TAGS="${TAGS},mrtazz/checkmake:latest"
        fi
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "Docker tags: ${TAGS}"

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        build-args: |
          BUILDER_NAME=GitHub Actions
          BUILDER_EMAIL=noreply@actions.github.com
        push: true
        tags: ${{ steps.docker_tags.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
